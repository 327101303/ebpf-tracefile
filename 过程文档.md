# 一、项目介绍
ctrace实现了一个基于eBPF的容器跟踪工具和权限最小集分配工具，用于帮助用户跟踪容器行为、防范恶意攻击。它可以跟踪已存在和新开启的容器，收集各类信息并打印或以json文件的形式储存。同时它可以根据容器的行为通过linux系统的seccomp功能自动为容器分配权限最小集。ctrace的主要功能如下：
1.  采集数据：使用Linux系统的eBPF技术对容器进行筛选跟踪与数据采集。
2.  数据存储：将采集获得的数据按一定格式存储到json文件中。
3.  权限最小集分配：使用seccomp技术根据json文件中跟踪到的系统调用来给容器分配权限。

ctrace并没有采用相对比较成熟的BCC开发模式，而是使用libbpf-go进行开发，从而实现了CORE特性，摆脱了对内核版本的依赖（但仍需5.10以上的内核版本），使得eBPF程序的开发可以更加专注于功能本身而不是某个结构/函数是否随内核版本发生了改变。go语言用于用户程序开发也更易与当今云原生主流应用对接。

# 二、项目规划
| 时间 | 任务 | 达成情况 |
| ------ | ------ | ------ |
| 2022/4/20 - 2022/5/2 | 学习eBPF相关知识，确定项目实现方式 | 完成 |
| 2022/5/3 - 2022/5/4 | 搭建项目开发环境 | 完成 |
| 2022/5/5 - 2022/5/8 | 设计编写程序基础框架 | 完成 |
| 2022/5/9 - 2022/5/13 | 实现指定跟踪容器功能 | 完成 |
| 2022/5/14 - 2022/5/15 | 更换项目实现方式为libbpf-go | 完成 |
| 2022/5/16 - 2022/5/21 | 实现跟踪容器系统调用功能 | 完成 |
| 2022/5/22 - 2022/5/26 | 实现跟踪容器文件访问功能 | 完成 |
| 2022/5/27 - 2022/5/28 | 实现记录跟踪数据存储功能 | 完成 |
| 2022/5/29 - 2022/6/4 | 过程文档编写完善 | 进行 |
| 2022/6/3 - 2022/6/15 | 实现跟踪容器间互访功能 | 进行 |
| 2022/6/16 - 2022/6/20 | 实现使用seccomp自动读取数据分配权限最小集功能 | 待办 |

# 三、设计思路
通过阅读eBPF相关文章、学习类似项目经验，我们决定使用libbpf-go作为ctrace的实现方式。首先编写eBPF程序跟踪记录内核中各个进程进行的系统调用和文件访问等行为，分别对其编写函数并进行相应处理。随后根据cgroup id将容器进程挑选出来，再通过eBPF Map将采集到的信息传递给用户空间程序进一步的处理。用户程序则负责格式化打印储存event信息、跟踪选项设置、容器权限配置等功能的实现。程序架构如下所示：
![程序架构.png](https://s2.loli.net/2022/06/05/2jvIH9z7J3FtV14.png)